#!/usr/bin/env bash
set -euo pipefail

PACKAGE="1password"
SSH_DIR="$HOME/.ssh"
CONFIG_FILE="$SSH_DIR/config"
IDENTITY_AGENT_LINE="IdentityAgent ~/.1password/agent.sock"
SSH_BLOCK=$'\n# 1Password SSH\nHost *\n  IdentityAgent ~/.1password/agent.sock'
EXPORT_LINE='export SSH_AUTH_SOCK=~/.1password/agent.sock'

needs_config=false
if [[ ! -f "$CONFIG_FILE" ]] || ! grep -Fq "$IDENTITY_AGENT_LINE" "$CONFIG_FILE" 2>/dev/null; then
    needs_config=true
fi

if [[ ! -f "$SHELL_PROFILE" ]] || ! grep -Fq "$EXPORT_LINE" "$SHELL_PROFILE" 2>/dev/null; then
    needs_config=true
fi

if $needs_config; then
    read -rp "Configure SSH to use 1Password agent? [Y/n]: " confirm
    confirm="${confirm:-Y}"
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        mkdir -p "$SSH_DIR"
        touch "$CONFIG_FILE"
        grep -Fq "$IDENTITY_AGENT_LINE" "$CONFIG_FILE" || echo "$SSH_BLOCK" >> "$CONFIG_FILE"
        grep -Fq "$EXPORT_LINE" "$SHELL_PROFILE" || echo -e "\n# 1Password SSH agent\n$EXPORT_LINE" >> "$SHELL_PROFILE"
        echo "SSH configuration updated."
    else
        echo "SSH configuration skipped."
    fi
else
    echo "SSH already configured."
fi

