#!/usr/bin/env bash
set -euo pipefail

PACKAGE="1password"

if ! command -V paru >/dev/null 2>&1; then
	echo "paru is not installed" 
	exit 0
fi

if pacman -Q "$PACKAGE" >/dev/null 2>&1; then
	echo "$PACKAGE is already installed"
else
	echo "Installing $PACKAGE using paru..."
	paru -S --needed --noconfirm "$PACKAGE"
fi



# Configure SSH with 1Password
CONFIG_FILE="$HOME/.ssh/config"
IDENTITY_AGENT_LINE="IdentityAgent ~/.1password/agent.sock"
BLOCK="Host *\n  $IDENTITY_AGENT_LINE"
EXPORT_LINE="export SSH_AUTH_SOCK=~/.1password/agent.sock"
PROFILE_FILE="$HOME/.zshrc" # or ~/.zshrc depending on your shell

# Ask for confirmation
read -rp "Configure SSH to use 1Password agent? [Y/n]: " CONFIRM
CONFIRM="${CONFIRM:-Y}"

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "❌ Cancelled by user."
    exit 0
fi

# Ensure ~/.ssh directory exists
mkdir -p "$HOME/.ssh"
touch "$CONFIG_FILE"

# Add IdentityAgent block if not already present
if ! grep -Fq "$IDENTITY_AGENT_LINE" "$CONFIG_FILE"; then
    echo -e "\n# Added by 1Password SSH agent setup\n$BLOCK" >> "$CONFIG_FILE"
    echo "Added IdentityAgent block to $CONFIG_FILE"
else
    echo "IdentityAgent block already present in $CONFIG_FILE"
fi

# Optionally add SSH_AUTH_SOCK to shell profile
if ! grep -Fq "$EXPORT_LINE" "$PROFILE_FILE"; then
    echo -e "\n# 1Password SSH agent\n$EXPORT_LINE" >> "$PROFILE_FILE"
    echo "Added SSH_AUTH_SOCK export to $PROFILE_FILE"
else
    echo "SSH_AUTH_SOCK already set in $PROFILE_FILE"
fi

echo "SSH is now configured to use the 1Password agent."

